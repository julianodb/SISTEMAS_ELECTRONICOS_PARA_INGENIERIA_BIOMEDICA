# <img src="https://julianodb.github.io/SISTEMAS_ELECTRONICOS_PARA_INGENIERIA_BIOMEDICA/img/logo_fing.png?raw=true" align="right" height="45"> Trabajo 6 de Sistemas Electrónicos

#### Primer Semestre de 2025

## Introducción

Este semestre, su grupo es responsable de diseñar y fabricar un prototipo de fotopletismógrafo para aplicar los conocimientos y tecnicas relacionados a la asignatura de Sistemas Electrónicos.

A grandes rasgos, el prototipo debe tener las siguientes funcionalidades:

1. medir la frecuencia cardíaca (Heart Rate - HR)
1. emitir una señal de luz infrarroja cuando hay un pulso cardíaco
1. detectar la señal infraroja emitida por otro prototipo
1. medir el tiempo entre la detección de la señal infrarroja y el siguiente pulso cardíaco (Pulse Transit Time - PTT)
1. Permitir la visualización de los valores de HR y PTT medidos

El sistema que deben diseñar puede ser dividido en los siguientes bloques:

![TX](../img/TX.png)

Figura 1: División del sistema del fotopletismógrafo en bloques

En el sexto trabajo, los objetivos son los siguientes:

1. implementar el detector óptico y amplificador, los cuales producen la señal de fotopletismografía
1. implementar el filtro 1, el cual elimina la parte DC de la señal de fotopletismografía
1. mejorar el detector de peak utilizando un circuito de diodo ideal

El trabajo será un ensayo que debe contener la siguiente información:

- Identificación del grupo (color)
- Identificación de los integrantes del grupo (nombres, apellidos y RUT)
- La información que se pide en cada una de las siguientes sesiones de este documento

## 1. Detector Óptico y amplificador

Como visto anteriormente, fotodiodos convierten intensidad luminosa en una corriente eléctrica. El objetivo de esta sesión es diseñar el circuito que convierte la corriente eléctrica resultante en un voltaje. También es necesario amplificar el voltaje obtenido porque la señal de fotopletismografía suele ser pequeña.

Una forma simple de convertir corriente en voltaje es utilizando una resistencia, de la siguiente forma:

Figura 2: Convertidor de corriente del fotodiodo en un voltaje

1. Considerando que $R=1\ k\Omega$, calculen (0.6pt) :
   1. La relación entre el voltaje de salida $v_o$ y la corriente del fotodiodo, $i_p$
   1. La impedancia de salida del circuito 
   1. Cuanto vale $V_D$ cuando $i_p = 0$, $i_p = 0.01\ mA$ y $i_p = 0.1\ mA$. 

El circuito de la figura 2 tiene dos grandes desventajas:
  - La impedancia de salida es muy alta
  - El voltaje del diodo cambia junto con $v_o$

El segundo punto distorciona la señal de salida, porque la corriente del diodo será proporcional no sólo a la intensidad luminosa, sino que también a los cambios en $V_D$.

Para mitigar los problemas con el circuito de la figura 2, utilizaremos un circuito conocido como amplificador de transimpedancia (del inglés, transimpedance amplifier, algunas veces abreviado como TIA). El nombre puede parecer rebuscado, pero recordando que impedancia es similar a la resistencia en el sentido que se definen como la razón entre el voltaje y la corriente ($R=\frac{V}{I}$, $Z=\frac{\mathbb{V}}{\mathbb{I}}$, donde $\mathbb{V}$ y $\mathbb{I}$ son los fasores de voltaje y corriente, respectivamente), se puede entender que transimpedancia es simplemente la razón entre un voltaje de salida y una corriente de entrada. Es decir, amplificador de transimpedancia literalmente significa un amplificador que convierte corrientes en voltajes. La siguiente figura muestra el circuito del TIA que utilizaremos. Al igual que en trabajos anteriores, el amplificador operacional elegido es el MCP6009.

Figura 3: Amplificador de Transimpedancia 

2. Elijan un valor de $R_{23}$ de tal forma que $v_o \approx 1000 i_p$ y calculen (0.5pt) :
   1. La impedancia de salida del circuito 
   1. Cuanto vale $V_D$ cuando $i_p = 0$, $i_p = 0.01\ mA$ y $i_p = 0.1\ mA$.

comentario sobre C compensation

Figura 4: Amplificador de Transimpedancia Compensado

## 2. Filtro 1

El SFH 7070 puede ser utilizado como en la Figura 5 (a), de forma a obtener una señal de corriente que es similar a lo que se muestra en la Figura 5 (c). En la Figura 6 se destaca que la señal tiene una componente DC y otra AC. Tipicamente la amplitud AC es al menos 100 veces menor que la línea de base DC. Por ejemplo, podría detectarse una corriente de 1 mA, sobre la cual hay una señal de PPG con amplitud 0.01 mA.

![ppg_principle](../img/ppg_principle.png)

Figura 5: Principio de fotopletismografía. Tomada de Dzedzickis, Andrius & Kaklauskas, Arturas & Bučinskas, Vytautas. (2020). Human Emotion Recognition: Review of Sensors and Methods. Sensors. 20. 592. 10.3390/s20030592. 

![ppg](../img/ppg.png)

Figura 6: Señal PPG. Tomada de Yung-Hui Li, Latifa Nabila Harfiya, Ching-Chun Chang, "Featureless Blood Pressure Estimation Based on Photoplethysmography Signal Using CNN and BiLSTM for IoT Devices", Wireless Communications and Mobile Computing, vol. 2021, Article ID 9085100, 10 pages, 2021. https://doi.org/10.1155/2021/9085100

Utilizando el amplificador de transimpedancia diseñado en la sesión anterior, la señal resultante sería un voltaje de 1 V DC sumada a una señal de PPG con amplitud 15 mV.

En esta sesión, el objetivo es diseñar un circuito que remueve la componente DC del voltaje resultante, obteniendo así la señal de PPG más pura. Nótese que la componente DC que se debe remover no siempre tiene el mismo valor: en realidad varía dependiendo del tono de piel, ubicación del sensor y con cuanta presión se presiona el sensor contra la piel del paciente. Por lo tanto, el circuito a proyectar debe ser capaz de adaptarse al valor DC de la señal en tiempo real.

La estrategia que utilizaremos para cumplir con el objetivo es aplicar un sistema de control en malla cerrada. Es decir, vamos a crear un circuito que mide la señal de salida y produce una señal de error relacionada al voltaje DC, para luego generar una corriente proporcional al error y restarla de la corriente del fotodiodo $i_p$. La siguiente figura muestra un diagrama de la estrategia elegida:

Figura 7: Sistema en malla cerrada para remover la componente DC de $v_o$.

Para producir una señal de error relacionada a la componente DC de $v_o$ utilizaremos un integrador. La motivación es que al integrar una señal, se atenuan las partes AC de la señal, mientras que se amplifica la parte DC. Por ejemplo, para una señal de entrada $v_i = 1 + 0.01 cos(10t)$, su integral sería $\int v_i = 1t + 0.001sen(10t)$ . Es decir, la parte AC tiene una amplitud 10 veces menor, mientras que la parte DC se convirtió en un voltaje que crece tendiendo al infinito.

Recordando que $\mathcal{L}\{\int f(t)\} = F(s) / s$
Determinen la f


remover linea de base: error proporcional a la integral de la señal ... integrador Deboo

juntando todo

$R_{23}=1\ k\Omega$

$C_5 = 10\ \mu F$

$R_{24}=10\ k\Omega$

$C_6 = 10\ \mu F$

$R_{28}=1\ M\Omega$

$R_{25}=1\ M\Omega$

$\frac{R_{26}}{R_{27}}= 100$ ?


## 3. Detector de Peak parte 2

En el trabajo 3 estudiamos como se generará el valor de PTT: primero se produce una señal de pulsos de voltaje con la misma duración que el PTT, luego la utilizamos como entrada del integrador para producir una señal triangular que empieza en cero y sube a una velocidad constante mientras el pulso está en 5 V. Cuando el pulso baja a cero, la señal triangular también baja a cero

![T3_PTT](../img/T3_PTT.png)

Figura 9: Medición de PTT

De ésta forma, el valor maximo de la señal triangular será proporcional al valor de PTT. Finalmente, proyectamos el circuito detector de peak cuya salida es efectivamente dicho valor maximo.

<img src="https://julianodb.github.io/electronic_circuits_diagrams/peak_detector.png" width="200">

Figura 10: Peak detector

Sin embargo, el peak detector proyectado tiene una desventaja: el valor de $v_o$ no es exactamente $max\{v_i\}$, sino que $max\{v_i\} - V_F$, donde el $V_F$ del diodo utilizado es aproximadamente 0.7 V.

En este trabajo reemplazaremos $D_4$ por un circuito conocido como rectificador de precisión, que actúa como un diodo ideal con $V_F=0$.


Figura XX: Rectificador de precisión


Figura YY: Rectificador de media onda

17. Calculen $v_o$ en ambos circuitos cuando $v_i > 0$ y cuando $v_i < 0$ y comparenlos. Asuman

18. Calculen $v_x$ en el circuito rectificador de prescisión cuando $v_i > 0$ y considerando que el $V_F$ de $D_X$ es 0.7 V. Basandose en la respuesta, determinen cual es el mayor valor de $v_i$ con el cual el circuito actúa como un diodo ideal.

AYUDA: Analicen el caso $v_i >0$ y el caso $v_i <0$ por separado.

AYUDA2: Al igual que en el primer módulo de la asignatura, remuevan el diodo del circuito, analicen los voltajes resultantes y, de acuerdo a esto, determinen si el diodo conduce o no.

AYUDA3: Tanto cuando remueven el diodo cuanto después de determinar si está conduciendo o no, consideren si hay realimentación negativa para el amplificador operacional. Si no hay, este actua como un comparador. Si hay, pueden aplicar cortocircuito virtual.

Finalmente, el circuito final del peak detector se muestra a continuación:

<img src="https://julianodb.github.io/electronic_circuits_diagrams/precision_peak_detector.png" width="200">

Figura 10: Peak detector con rectificador de precisión


## Plazo de entrega: 23:59, 14 de Mayo de 2025

## Anexo

I. Valores de Resistencias disponibles:

|   |  |        |       |  |
|------|------|-----------|------------|-------|
| 10Ω  | 220Ω | 1kΩ       | 6.8kΩ      | 100kΩ |
| 22Ω  | 270Ω | 2kΩ       | 10kΩ       | 220kΩ |
| 47Ω  | 330Ω | 2.2kΩ     | 20kΩ       | 300kΩ |
| 100Ω | 470Ω | 3.3kΩ     | 47kΩ       | 470kΩ |
| 150Ω | 510Ω | 4.7kΩ     | 51kΩ       | 680kΩ |
| 200Ω | 680Ω | 5.1kΩ     | 68kΩ       | 1M    |

II. Valores de Capacitores Ceramicos disponibles:

|   |  |        |       |  |
|------|------|-----------|------------|-------|
| 100 pF  | 220 pF | 330 pF | 470 pF | 680 pF |
| 1 nF  | 2.2 nF | 3.3 nF | 4.7 nF | 6.8 nF |
| 10 nF  | 22 nF | 33 nF | 47 nF | 68 nF |
| $0.1\ \mu F$  | $0.22\ \mu F$ | $0.33\ \mu F$| $0.47\ \mu F$ | $0.68\ \mu F$ |
| $1\ \mu F$  | - | - | $4.7\ \mu F$ | - |
| $10\ \mu F$  | $22\ \mu F$ | - | - | - |
